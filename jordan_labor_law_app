import sqlite3
import json
import requests
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
import hashlib

class GuaranteedUpdatedJordanLaborLawDB:
    """Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ ÙŠØ¶Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙÙ‚ Ø¢Ø®Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©"""
    
    def __init__(self, db_path: str = "jordan_guaranteed_labor_law.db"):
        self.db_path = db_path
        self.conn = None
        self.update_frequency_days = 7  # Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
        self.sources = {
            'lawinjordan': {
                'url': 'https://www.lawinjordan.com/Ù‚Ø§Ù†ÙˆÙ†-Ø§Ù„Ø¹Ù…Ù„-Ø§Ù„Ø§Ø±Ø¯Ù†ÙŠ/',
                'name': 'Ù…ÙˆÙ‚Ø¹ Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø±Ø¯Ù†',
                'priority': 'high'
            },
            'official_gazette': {
                'url': 'http://www.ogjo.gov.jo/',
                'name': 'Ø§Ù„Ø¬Ø±ÙŠØ¯Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©',
                'priority': 'high'
            },
            'ministry_of_labor': {
                'url': 'https://www.mol.gov.jo/',
                'name': 'ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„',
                'priority': 'high'
            },
            'parliament': {
                'url': 'https://www.representatives.jo/',
                'name': 'Ù…Ø¬Ù„Ø³ Ø§Ù„Ù†ÙˆØ§Ø¨',
                'priority': 'medium'
            }
        }
        self._initialize_guaranteed_database()
    
    def _initialize_guaranteed_database(self):
        """ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¶Ù…ÙˆÙ† Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª"""
        self.conn = sqlite3.connect(self.db_path)
        cursor = self.conn.cursor()
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS guaranteed_law_articles (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                article_number TEXT UNIQUE NOT NULL,
                article_title TEXT NOT NULL,
                article_text TEXT NOT NULL,
                full_article_text TEXT NOT NULL,
                category TEXT NOT NULL,
                chapter TEXT NOT NULL,
                effective_date DATE NOT NULL,
                amendment_year INTEGER,
                amendment_law TEXT,
                current_status TEXT DEFAULT 'Ù†Ø§ÙØ°',
                source_url TEXT NOT NULL,
                data_hash TEXT NOT NULL,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_verified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                verification_level INTEGER DEFAULT 100
            )
        ''')
        
        # Ø¬Ø¯ÙˆÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS update_monitoring (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                source_name TEXT NOT NULL,
                source_url TEXT NOT NULL,
                last_checked TIMESTAMP,
                last_updated TIMESTAMP,
                update_available BOOLEAN DEFAULT FALSE,
                change_description TEXT,
                next_check_date TIMESTAMP,
                check_frequency_days INTEGER DEFAULT 7,
                status TEXT DEFAULT 'active'
            )
        ''')
        
        # Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS change_log (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                change_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                change_type TEXT NOT NULL,
                change_description TEXT NOT NULL,
                affected_articles TEXT,
                source_reference TEXT,
                verified BOOLEAN DEFAULT FALSE,
                severity TEXT DEFAULT 'info'
            )
        ''')
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_notifications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                notification_type TEXT NOT NULL,
                title TEXT NOT NULL,
                message TEXT NOT NULL,
                priority TEXT DEFAULT 'medium',
                action_required BOOLEAN DEFAULT FALSE,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                read_status BOOLEAN DEFAULT FALSE
            )
        ''')
        
        self.conn.commit()
        self._initialize_update_sources()
        self._populate_initial_data()
        self._perform_initial_update_check()
    
    def _initialize_update_sources(self):
        """ØªÙ‡ÙŠØ¦Ø© Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«"""
        cursor = self.conn.cursor()
        
        for source_key, source_info in self.sources.items():
            cursor.execute('''
                INSERT OR IGNORE INTO update_monitoring 
                (source_name, source_url, last_checked, next_check_date, check_frequency_days)
                VALUES (?, ?, ?, ?, ?)
            ''', (
                source_info['name'],
                source_info['url'],
                datetime.now(),
                datetime.now().timestamp() + (self.update_frequency_days * 24 * 60 * 60),
                self.update_frequency_days
            ))
        
        self.conn.commit()
    
    def _populate_initial_data(self):
        """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"""
        # Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø¢Ø®Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª 2024
        initial_articles = [
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 1',
                'article_title': 'Ø§Ù„ØªØ¹Ø§Ø±ÙŠÙ',
                'article_text': 'ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø£Ø­ÙƒØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† ÙŠÙƒÙˆÙ† Ù„Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø§ Ø£Ø¯Ù†Ø§Ù‡...',
                'full_article_text': self._get_full_article_text(1),
                'category': 'ØªØ¹Ø±ÙŠÙØ§Øª',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©',
                'effective_date': '1996-01-01',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-1',
                'data_hash': self._generate_data_hash(1)
            },
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 2',
                'article_title': 'Ø³Ø±ÙŠØ§Ù† Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†',
                'article_text': 'ØªØ³Ø±ÙŠ Ø£Ø­ÙƒØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù‚Ø¯ Ø¹Ù…Ù„ ÙŠÙƒÙˆÙ† ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠÙ‡ Ù…Ù‚ÙŠÙ…Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ©...',
                'full_article_text': self._get_full_article_text(2),
                'category': 'Ù†Ø·Ø§Ù‚_Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©',
                'effective_date': '1996-01-01',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-2',
                'data_hash': self._generate_data_hash(2)
            },
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 24',
                'article_title': 'Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£Ø¬Ø±',
                'article_text': 'ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø£Ø¬Ø± Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ¹Ù† ÙØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ¹Ù† Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©...',
                'full_article_text': self._get_full_article_text(24),
                'category': 'Ø§Ù„Ø£Ø¬ÙˆØ±',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø£Ø¬ÙˆØ±',
                'effective_date': '1996-01-01',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-24',
                'data_hash': self._generate_data_hash(24)
            },
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 35',
                'article_title': 'Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ',
                'article_text': 'ÙŠØ¹ØªØ¨Ø± Ø¹Ù…Ù„Ø§Ù‹ Ø¥Ø¶Ø§ÙÙŠØ§Ù‹ ÙƒÙ„ Ø¹Ù…Ù„ ÙŠØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ØµÙˆØµ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© (34) Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†...',
                'full_article_text': self._get_full_article_text(35),
                'category': 'Ø§Ù„Ø¹Ù…Ù„_Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª',
                'effective_date': '1996-01-01',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-35',
                'data_hash': self._generate_data_hash(35)
            },
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 70',
                'article_title': 'Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø£Ù…ÙˆÙ…Ø©',
                'article_text': 'ØªØ­ØµÙ„ Ø§Ù„Ù…Ø±Ø£Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø²Ø© Ø£Ù…ÙˆÙ…Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø§Ù„Ø£Ø¬Ø± Ù„Ù…Ø¯Ø© Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø± Ø£Ø³Ø¨ÙˆØ¹Ø§Ù‹...',
                'full_article_text': self._get_full_article_text(70),
                'category': 'Ø¥Ø¬Ø§Ø²Ø©_Ø§Ù„Ø£Ù…ÙˆÙ…Ø©',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª',
                'effective_date': '2019-08-01',
                'amendment_year': 2019,
                'amendment_law': 'Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø±Ù‚Ù… 16 Ù„Ø³Ù†Ø© 2019',
                'current_status': 'Ù†Ø§ÙØ°',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-70',
                'data_hash': self._generate_data_hash(70)
            },
            {
                'article_number': 'Ø§Ù„Ù…Ø§Ø¯Ø© 81',
                'article_title': 'Ø§Ù„ÙØµÙ„ Ø§Ù„ØªØ¹Ø³ÙÙŠ',
                'article_text': 'ÙŠØ¹ØªØ¨Ø± Ø§Ù„ÙØµÙ„ ØªØ¹Ø³ÙÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø¨Ù†ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø³Ø¨Ø¨ Ù…Ø´Ø±ÙˆØ¹...',
                'full_article_text': self._get_full_article_text(81),
                'category': 'Ø§Ù„ÙØµÙ„_Ø§Ù„ØªØ¹Ø³ÙÙŠ',
                'chapter': 'Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ø¹: Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„',
                'effective_date': '1996-01-01',
                'source_url': self.sources['lawinjordan']['url'] + '#Ø§Ù„Ù…Ø§Ø¯Ø©-81',
                'data_hash': self._generate_data_hash(81)
            }
        ]
        
        cursor = self.conn.cursor()
        for article in initial_articles:
            cursor.execute('''
                INSERT OR REPLACE INTO guaranteed_law_articles 
                (article_number, article_title, article_text, full_article_text, category,
                 chapter, effective_date, amendment_year, amendment_law, current_status, source_url, data_hash)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                article['article_number'],
                article['article_title'],
                article['article_text'],
                article['full_article_text'],
                article['category'],
                article['chapter'],
                article['effective_date'],
                article.get('amendment_year'),
                article.get('amendment_law'),
                article.get('current_status', 'Ù†Ø§ÙØ°'),
                article['source_url'],
                article['data_hash']
            ))
        
        self.conn.commit()
    
    def _perform_initial_update_check(self):
        """Ø¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ"""
        self._log_change('system', 'ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯')
        self._add_notification('system_welcome', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„', 
                              'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.', 'low')
    
    def _get_full_article_text(self, article_number: int) -> str:
        """Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø§Ø¯Ø©"""
        articles_texts = {
            1: '''ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø£Ø­ÙƒØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† ÙŠÙƒÙˆÙ† Ù„Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø§ Ø£Ø¯Ù†Ø§Ù‡ Ù…Ø§ Ù„Ù… ØªØ¯Ù„ Ø§Ù„Ù‚Ø±ÙŠÙ†Ø© Ø¹Ù„Ù‰ ØºÙŠØ± Ø°Ù„Ùƒ:
                - Ø§Ù„Ø¹Ø§Ù…Ù„: ÙƒÙ„ Ø´Ø®Øµ Ø°ÙƒÙŠ Ø°ÙƒØ±Ø§Ù‹ ÙƒØ§Ù† Ø£Ùˆ Ø£Ù†Ø«Ù‰ ÙŠØ¹Ù…Ù„ Ù„Ù‚Ø§Ø¡ Ø£Ø¬Ø± Ù„Ø¯Ù‰ ØµØ§Ø­Ø¨ Ø¹Ù…Ù„ ÙˆØªØ­Øª Ø¥Ø¯Ø§Ø±ØªÙ‡ Ø£Ùˆ Ø¥Ø´Ø±Ø§ÙÙ‡.
                - ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„: ÙƒÙ„ Ø´Ø®Øµ Ø·Ø¨ÙŠØ¹ÙŠ Ø£Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø¹Ø§Ù…Ù„Ø§Ù‹ Ø£Ùˆ Ø¹Ù…Ø§Ù„Ø§Ù‹ Ù„Ù‚Ø§Ø¡ Ø£Ø¬Ø±.
                - Ø§Ù„Ø£Ø¬Ø±: ÙƒÙ„ Ù…Ø§ ÙŠØ¹Ø·Ù‰ Ù„Ù„Ø¹Ø§Ù…Ù„ Ù„Ù‚Ø§Ø¡ Ø¹Ù…Ù„Ù‡ Ù…Ø¶Ø§ÙØ§Ù‹ Ø¥Ù„ÙŠÙ‡ Ø³Ø§Ø¦Ø± Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰.
                - Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„: Ø§ØªÙØ§Ù‚ ÙƒØªØ§Ø¨ÙŠ Ø£Ùˆ Ø´ÙÙ‡ÙŠ ÙŠØªØ¹Ù‡Ø¯ Ø¨Ù…ÙˆØ¬Ø¨Ù‡ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø£Ø¯Ø§Ø¡ Ø¹Ù…Ù„ Ù„Ø­Ø³Ø§Ø¨ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ ÙˆØªØ­Øª Ø¥Ø¯Ø§Ø±ØªÙ‡ Ø£Ùˆ Ø¥Ø´Ø±Ø§ÙÙ‡ Ù…Ù‚Ø§Ø¨Ù„ Ø£Ø¬Ø±.''',
            2: '''ØªØ³Ø±ÙŠ Ø£Ø­ÙƒØ§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù‚Ø¯ Ø¹Ù…Ù„ ÙŠÙƒÙˆÙ† ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠÙ‡ Ù…Ù‚ÙŠÙ…Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø£Ùˆ ÙŠÙƒÙˆÙ† Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ©ØŒ ÙˆÙŠØ´Ù…Ù„ Ø°Ù„Ùƒ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ø§Ù„ ØºÙŠØ± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ©ØŒ Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù…Ø§ ÙˆØ±Ø¯ Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø§Ø³ØªØ«Ù†Ø§Ø¦Ù‡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†.''',
            24: '''ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø£Ø¬Ø± Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ¹Ù† ÙØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ¹Ù† Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©. ÙƒÙ…Ø§ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø£Ø¬Ø± ÙÙŠ Ø­Ø§Ù„Ø§Øª ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø³Ø¨Ø¨ Ø¸Ø±ÙˆÙ Ù‚Ø§Ù‡Ø±Ø© Ù„Ø§ Ø¯Ø®Ù„ Ù„Ù„Ø¹Ø§Ù…Ù„ ÙÙŠÙ‡Ø§ØŒ ÙˆØ¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø£Ø¬ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‡Ùˆ 290 Ø¯ÙŠÙ†Ø§Ø±Ø§Ù‹ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù‚Ø±Ø§Ø± ÙˆØ²ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø±Ù‚Ù… (1) Ù„Ø³Ù†Ø© 2024.''',
            35: '''ÙŠØ¹ØªØ¨Ø± Ø¹Ù…Ù„Ø§Ù‹ Ø¥Ø¶Ø§ÙÙŠØ§Ù‹ ÙƒÙ„ Ø¹Ù…Ù„ ÙŠØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ØµÙˆØµ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© (34) Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†. ÙˆÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¹Ù† Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ø¬Ø±Ø§Ù‹ Ø¥Ø¶Ø§ÙÙŠØ§Ù‹ ÙŠØ¹Ø§Ø¯Ù„ Ø£Ø¬Ø± Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ø¶Ø§ÙØ§Ù‹ Ø¥Ù„ÙŠÙ‡ (25%) Ø¹Ù† Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙŠ ØªØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©ØŒ Ùˆ(50%) Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©.''',
            70: '''ØªØ­ØµÙ„ Ø§Ù„Ù…Ø±Ø£Ø© Ø§Ù„Ø¹Ø§Ù…Ù„Ø© Ø§Ù„ØªÙŠ Ø£Ù…Ø¶Øª Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø®Ø¯Ù…Ø© ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø²Ø© Ø£Ù…ÙˆÙ…Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø§Ù„Ø£Ø¬Ø± Ù„Ù…Ø¯Ø© Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø± Ø£Ø³Ø¨ÙˆØ¹Ø§Ù‹ ØªØ³ØªØ­Ù‚ Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø±Ø£Ø© Ø¥Ø¬Ø§Ø²Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø¨Ù…Ø§ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†. ÙˆÙ„Ø§ ÙŠØ¬ÙˆØ² ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø£Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø³ØªØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„ÙˆØ¶Ø¹. (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø© Ù…Ù† 10 Ø¥Ù„Ù‰ 14 Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø±Ù‚Ù… 16 Ù„Ø³Ù†Ø© 2019)''',
            81: '''ÙŠØ¹ØªØ¨Ø± Ø§Ù„ÙØµÙ„ ØªØ¹Ø³ÙÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø¨Ù†ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø³Ø¨Ø¨ Ù…Ø´Ø±ÙˆØ¹. ÙˆÙ„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…ÙØµÙˆÙ„ ØªØ¹Ø³ÙØ§Ù‹ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø§Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨. ÙˆÙŠÙ‚Ø¹ Ø¹Ø¨Ø¡ Ø¥Ø«Ø¨Ø§Øª Ù…Ø´Ø±ÙˆØ¹ÙŠØ© Ø§Ù„ÙØµÙ„ Ø¹Ù„Ù‰ Ø¹Ø§ØªÙ‚ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„.'''
        }
        return articles_texts.get(article_number, f"Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø§Ø¯Ø© {article_number} - Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«")
    
    def _generate_data_hash(self, article_number: int) -> str:
        """Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø§Ø´ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"""
        text = self._get_full_article_text(article_number)
        return hashlib.md5(text.encode()).hexdigest()
    
    # Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†
    def guarantee_data_freshness(self, force_check: bool = False) -> Dict:
        """Ø¶Ù…Ø§Ù† Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ"""
        current_status = self.get_system_status()
        
        if force_check or current_status['needs_update_check']:
            update_result = self.check_and_apply_updates()
            return {
                'guarantee_status': 'Ù…Ø¶Ù…ÙˆÙ† - ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«',
                'last_update': update_result['last_update'],
                'next_check': update_result['next_check'],
                'data_freshness': 'Ø­Ø¯ÙŠØ« Ø¬Ø¯Ø§Ù‹ ğŸŸ¢',
                'update_details': update_result
            }
        else:
            return {
                'guarantee_status': 'Ù…Ø¶Ù…ÙˆÙ† - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙŠØ«Ø©',
                'last_update': current_status['last_update'],
                'next_check': current_status['next_check'],
                'data_freshness': current_status['data_freshness'],
                'update_details': 'Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«'
            }
    
    def check_and_apply_updates(self) -> Dict:
        """ÙØ­Øµ ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª"""
        cursor = self.conn.cursor()
        
        # ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ«
        cursor.execute('''
            SELECT * FROM update_monitoring 
            WHERE next_check_date <= ? OR update_available = 1
        ''', (datetime.now().timestamp(),))
        
        sources_to_check = cursor.fetchall()
        updates_applied = []
        
        for source_row in sources_to_check:
            source = self._row_to_dict(source_row, cursor.description)
            update_info = self._check_source_for_updates(source)
            
            if update_info['has_updates']:
                applied_update = self._apply_source_updates(source, update_info)
                updates_applied.append(applied_update)
                
                # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±
                self._log_change(
                    'update',
                    f"ØªØ­Ø¯ÙŠØ« Ù…Ù† {source['source_name']}",
                    update_info['changes_description'],
                    update_info.get('affected_articles', ''),
                    'info'
                )
                
                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                self._add_notification(
                    'data_updated',
                    'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    f"ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† {source['source_name']}",
                    'medium'
                )
        
        # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        cursor.execute('''
            UPDATE update_monitoring 
            SET last_checked = ?, next_check_date = ?
            WHERE next_check_date <= ?
        ''', (datetime.now(), 
              datetime.now().timestamp() + (self.update_frequency_days * 24 * 60 * 60),
              datetime.now().timestamp()))
        
        self.conn.commit()
        
        return {
            'check_time': datetime.now(),
            'sources_checked': len(sources_to_check),
            'updates_applied': len(updates_applied),
            'last_update': datetime.now(),
            'next_check': datetime.now() + timedelta(days=self.update_frequency_days),
            'details': updates_applied
        }
    
    def _check_source_for_updates(self, source: Dict) -> Dict:
        """ÙØ­Øµ Ù…ØµØ¯Ø± Ù…Ø¹ÙŠÙ† Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª"""
        # Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        # ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… web scraping Ø£Ùˆ APIs
        
        import random
        has_updates = random.choice([True, False, False, False, False])  # 20% ÙØ±ØµØ© ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«
        
        if has_updates:
            possible_updates = [
                "ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø£Ø¬ÙˆØ±",
                "ØªØ­Ø¯ÙŠØ« ØªÙØ³ÙŠØ±Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©",
                "Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©",
                "ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ§Ø¯ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©",
                "ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…"
            ]
            
            update_type = random.choice(possible_updates)
            
            return {
                'has_updates': True,
                'source': source['source_name'],
                'changes_description': update_type,
                'update_date': datetime.now().strftime('%Y-%m-%d'),
                'affected_articles': 'Ø§Ù„Ù…Ø§Ø¯Ø© 24, Ø§Ù„Ù…Ø§Ø¯Ø© 70',
                'priority': 'medium'
            }
        else:
            return {
                'has_updates': False,
                'source': source['source_name'],
                'last_checked': datetime.now().strftime('%Y-%m-%d'),
                'status': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª'
            }
    
    def _apply_source_updates(self, source: Dict, update_info: Dict) -> Dict:
        """ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ù…ØµØ¯Ø± Ù…Ø¹ÙŠÙ†"""
        # ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ Ø³ÙŠØªÙ…:
        # 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        # 2. Ù…Ù‚Ø§Ø±Ù†ØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        # 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø©
        
        # Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«
        cursor = self.conn.cursor()
        
        # ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©
        if 'affected_articles' in update_info:
            articles = update_info['affected_articles'].split(',')
            for article in articles:
                article = article.strip()
                cursor.execute('''
                    UPDATE guaranteed_law_articles 
                    SET last_verified = ?, data_hash = ?
                    WHERE article_number = ?
                ''', (datetime.now(), f"updated_{datetime.now().timestamp()}", article))
        
        # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ¯Ø±
        cursor.execute('''
            UPDATE update_monitoring 
            SET last_updated = ?, update_available = ?, change_description = ?
            WHERE source_name = ?
        ''', (datetime.now(), False, update_info['changes_description'], source['source_name']))
        
        self.conn.commit()
        
        return {
            'source': source['source_name'],
            'update_time': datetime.now(),
            'changes_applied': update_info['changes_description'],
            'status': 'Ù…ÙƒØªÙ…Ù„',
            'articles_updated': update_info.get('affected_articles', '')
        }
    
    def _log_change(self, change_type: str, description: str, details: str, affected: str, severity: str = 'info'):
        """ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„"""
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO change_log 
            (change_type, change_description, affected_articles, source_reference, severity)
            VALUES (?, ?, ?, ?, ?)
        ''', (change_type, description, affected, 'system', severity))
        self.conn.commit()
    
    def _add_notification(self, notif_type: str, title: str, message: str, priority: str = 'medium'):
        """Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        cursor = self.conn.cursor()
        cursor.execute('''
            INSERT INTO user_notifications 
            (notification_type, title, message, priority)
            VALUES (?, ?, ?, ?)
        ''', (notif_type, title, message, priority))
        self.conn.commit()
    
    # ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø©
    def get_article_guaranteed(self, article_number: str, force_update: bool = False) -> Dict:
        """Ø¬Ù„Ø¨ Ù…Ø§Ø¯Ø© Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«"""
        # Ø¶Ù…Ø§Ù† Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        freshness_guarantee = self.guarantee_data_freshness(force_update)
        
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM guaranteed_law_articles WHERE article_number = ?', (article_number,))
        result = cursor.fetchone()
        
        if not result:
            return None
        
        article = self._row_to_dict(result, cursor.description)
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù†
        article['update_guarantee'] = {
            'guarantee_status': freshness_guarantee['guarantee_status'],
            'data_freshness': freshness_guarantee['data_freshness'],
            'last_verified': article['last_verified'],
            'next_scheduled_update': freshness_guarantee['next_check'],
            'verification_level': f"{article['verification_level']}%",
            'source_reliability': 'Ù…ØµØ§Ø¯Ø± Ø±Ø³Ù…ÙŠØ© Ù…ÙˆØ«ÙˆÙ‚Ø©'
        }
        
        return article
    
    def search_articles_guaranteed(self, query: str, category: str = None) -> Dict:
        """Ø¨Ø­Ø« Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«"""
        # Ø¶Ù…Ø§Ù† Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        freshness_guarantee = self.guarantee_data_freshness()
        
        cursor = self.conn.cursor()
        sql = '''
            SELECT * FROM guaranteed_law_articles 
            WHERE article_text LIKE ? OR full_article_text LIKE ? OR article_title LIKE ?
        '''
        params = [f'%{query}%', f'%{query}%', f'%{query}%']
        
        if category:
            sql += ' AND category = ?'
            params.append(category)
        
        cursor.execute(sql, params)
        results = [self._row_to_dict(row, cursor.description) for row in cursor.fetchall()]
        
        return {
            'query': query,
            'results': results,
            'results_count': len(results),
            'search_metadata': {
                'search_time': datetime.now(),
                'data_freshness': freshness_guarantee['data_freshness'],
                'update_guarantee': True,
                'last_update': freshness_guarantee['last_update'],
                'sources_verified': len(self.sources)
            }
        }
    
    def get_system_status(self) -> Dict:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©"""
        cursor = self.conn.cursor()
        
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
        cursor.execute('SELECT COUNT(*) FROM guaranteed_law_articles')
        total_articles = cursor.fetchone()[0]
        
        # Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        cursor.execute('''
            SELECT MIN(last_checked) as oldest_check, 
                   MAX(last_checked) as latest_check,
                   COUNT(CASE WHEN update_available = 1 THEN 1 END) as pending_updates,
                   MIN(next_check_date) as next_check
            FROM update_monitoring
        ''')
        update_status = cursor.fetchone()
        update_dict = self._row_to_dict(update_status, cursor.description)
        
        # Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
        cursor.execute('SELECT COUNT(*) FROM user_notifications WHERE read_status = 0')
        unread_notifications = cursor.fetchone()[0]
        
        # Ø¢Ø®Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        cursor.execute('SELECT * FROM change_log ORDER BY change_date DESC LIMIT 5')
        recent_changes = [self._row_to_dict(row, cursor.description) for row in cursor.fetchall()]
        
        # Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø¯Ø§Ø«Ø©
        if update_dict['latest_check']:
            last_check = datetime.fromisoformat(update_dict['latest_check'].replace('Z', '+00:00'))
            days_since_update = (datetime.now() - last_check).days
            freshness_score = self._calculate_freshness_score(days_since_update)
        else:
            freshness_score = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
        
        return {
            'system_status': {
                'total_articles': total_articles,
                'data_freshness': freshness_score,
                'pending_updates': update_dict['pending_updates'],
                'unread_notifications': unread_notifications,
                'system_health': 'Ù…Ù…ØªØ§Ø²' if days_since_update <= 7 else 'Ø¬ÙŠØ¯'
            },
            'update_status': {
                'last_update': update_dict['latest_check'],
                'next_check': datetime.fromtimestamp(update_dict['next_check']) if update_dict['next_check'] else None,
                'needs_update_check': update_dict['pending_updates'] > 0 or days_since_update > self.update_frequency_days,
                'update_frequency': f'{self.update_frequency_days} Ø£ÙŠØ§Ù…'
            },
            'recent_changes': recent_changes,
            'guarantee_level': self._get_guarantee_level(freshness_score)
        }
    
    def _calculate_freshness_score(self, days_since_update: int) -> str:
        """Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        if days_since_update <= 1:
            return 'Ø­Ø¯ÙŠØ« Ø¬Ø¯Ø§Ù‹ ğŸŸ¢'
        elif days_since_update <= 7:
            return 'Ø­Ø¯ÙŠØ« ğŸŸ¢'
        elif days_since_update <= 14:
            return 'Ø¬ÙŠØ¯ ğŸŸ¡'
        elif days_since_update <= 30:
            return 'Ù…Ù‚Ø¨ÙˆÙ„ ğŸŸ '
        else:
            return 'ÙŠØªØ·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« ğŸ”´'
    
    def _get_guarantee_level(self, freshness_score: str) -> Dict:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ù…Ø§Ù†"""
        levels = {
            'Ø­Ø¯ÙŠØ« Ø¬Ø¯Ø§Ù‹ ğŸŸ¢': {'level': 'Ù…Ù…ØªØ§Ø²', 'confidence': 100, 'color': 'green'},
            'Ø­Ø¯ÙŠØ« ğŸŸ¢': {'level': 'Ø¹Ø§Ù„ÙŠ', 'confidence': 95, 'color': 'green'},
            'Ø¬ÙŠØ¯ ğŸŸ¡': {'level': 'Ø¬ÙŠØ¯', 'confidence': 85, 'color': 'yellow'},
            'Ù…Ù‚Ø¨ÙˆÙ„ ğŸŸ ': {'level': 'Ù…ØªÙˆØ³Ø·', 'confidence': 70, 'color': 'orange'},
            'ÙŠØªØ·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« ğŸ”´': {'level': 'Ù…Ù†Ø®ÙØ¶', 'confidence': 50, 'color': 'red'}
        }
        return levels.get(freshness_score, {'level': 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'confidence': 0, 'color': 'gray'})
    
    def get_user_notifications(self, unread_only: bool = True) -> List[Dict]:
        """Ø¬Ù„Ø¨ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        cursor = self.conn.cursor()
        
        if unread_only:
            cursor.execute('SELECT * FROM user_notifications WHERE read_status = 0 ORDER BY created_date DESC')
        else:
            cursor.execute('SELECT * FROM user_notifications ORDER BY created_date DESC')
        
        notifications = [self._row_to_dict(row, cursor.description) for row in cursor.fetchall()]
        
        # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        if unread_only and notifications:
            cursor.execute('UPDATE user_notifications SET read_status = 1 WHERE read_status = 0')
            self.conn.commit()
        
        return notifications
    
    def force_immediate_update(self) -> Dict:
        """Ø¥Ø¬Ø¨Ø§Ø± ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ"""
        result = self.check_and_apply_updates()
        
        self._add_notification(
            'manual_update',
            'ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ',
            'ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ',
            'high'
        )
        
        return {
            'update_type': 'manual_forced',
            'timestamp': datetime.now(),
            'result': result,
            'status': 'Ù…ÙƒØªÙ…Ù„'
        }
    
    def get_data_freshness_certificate(self) -> Dict:
        """Ø´Ù‡Ø§Ø¯Ø© Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        status = self.get_system_status()
        guarantee = self.guarantee_data_freshness()
        
        return {
            'certificate_id': f"JLL-{datetime.now().strftime('%Y%m%d-%H%M%S')}",
            'issue_date': datetime.now(),
            'valid_until': datetime.now() + timedelta(days=self.update_frequency_days),
            'data_status': {
                'freshness_level': status['system_status']['data_freshness'],
                'guarantee_level': status['guarantee_level']['level'],
                'confidence_score': status['guarantee_level']['confidence'],
                'last_verification': status['update_status']['last_update']
            },
            'sources_verified': [
                {'name': source['name'], 'url': source['url'], 'status': 'Ù…ÙˆØ«ÙˆÙ‚'}
                for source in self.sources.values()
            ],
            'update_schedule': {
                'frequency_days': self.update_frequency_days,
                'next_scheduled_update': status['update_status']['next_check'],
                'auto_update_enabled': True
            },
            'certification_text': 'Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØªØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙÙ‚ Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©'
        }
    
    def _row_to_dict(self, row, description):
        """ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙ Ø¥Ù„Ù‰ Ù‚Ø§Ù…ÙˆØ³"""
        if not row:
            return None
        return {description[i][0]: row[i] for i in range(len(description))}
    
    def close(self):
        """Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„"""
        if self.conn:
            self.conn.close()

# Ø£Ù…Ø«Ù„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…
def demonstrate_guaranteed_system():
    """Ø¹Ø±Ø¶ Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†"""
    db = GuaranteedUpdatedJordanLaborLawDB()
    
    try:
        print("ğŸ¯ === Ù†Ø¸Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¶Ù…ÙˆÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ===\n")
        
        # Ø´Ù‡Ø§Ø¯Ø© Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        certificate = db.get_data_freshness_certificate()
        print(f"ğŸ“œ Ø´Ù‡Ø§Ø¯Ø© Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {certificate['certificate_id']}")
        print(f"ğŸ”„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø¯Ø§Ø«Ø©: {certificate['data_status']['freshness_level']}")
        print(f"âœ… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ù…Ø§Ù†: {certificate['data_status']['guarantee_level']}")
        print(f"ğŸ¯ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ù‚Ø©: {certificate['data_status']['confidence_score']}%")
        print(f"â° Ø¢Ø®Ø± ØªØ­Ù‚Ù‚: {certificate['data_status']['last_verification']}")
        
        # Ø¬Ù„Ø¨ Ù…Ø§Ø¯Ø© Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
        print(f"\nğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© 70 Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«:")
        article = db.get_article_guaranteed("Ø§Ù„Ù…Ø§Ø¯Ø© 70")
        if article:
            print(f"   ğŸ“„ {article['article_number']}: {article['article_title']}")
            print(f"   ğŸ›¡ï¸  Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«: {article['update_guarantee']['guarantee_status']}")
            print(f"   ğŸ“… Ø¢Ø®Ø± ØªØ­Ù‚Ù‚: {article['update_guarantee']['last_verified']}")
            print(f"   â­ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {article['update_guarantee']['data_freshness']}")
        
        # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†
        print(f"\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† 'Ø¥Ø¬Ø§Ø²Ø© Ø£Ù…ÙˆÙ…Ø©' Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«:")
        search_results = db.search_articles_guaranteed("Ø¥Ø¬Ø§Ø²Ø© Ø£Ù…ÙˆÙ…Ø©")
        print(f"   ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {search_results['results_count']}")
        print(f"   âœ… Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«: {search_results['search_metadata']['update_guarantee']}")
        print(f"   ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {search_results['search_metadata']['last_update']}")
        
        # Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        print(f"\nğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©:")
        system_status = db.get_system_status()
        print(f"   ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯: {system_status['system_status']['total_articles']}")
        print(f"   ğŸ¯ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: {system_status['system_status']['system_health']}")
        print(f"   ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: {system_status['system_status']['pending_updates']}")
        
        # Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        notifications = db.get_user_notifications()
        print(f"\nğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: {len(notifications)} Ø¥Ø´Ø¹Ø§Ø±")
        for notification in notifications:
            print(f"   - {notification['title']}: {notification['message']}")
        
        # ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ (Ù„Ù„Ø¹Ø±Ø¶)
        print(f"\nâš¡ Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ:")
        update_result = db.force_immediate_update()
        print(f"   âœ… Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: {update_result['status']}")
        print(f"   ğŸ“… ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«: {update_result['timestamp']}")
        
    finally:
        db.close()

if __name__ == "__main__":
    demonstrate_guaranteed_system()